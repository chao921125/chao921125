<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PDF 2 Excel</title>

    <link href="https://unpkg.com/pdfjs-dist@3.9.179/web/pdf_viewer.css" rel="stylesheet" />
    <style>
        table {
            padding: 0;
            margin: 0;
            border-right: 1px solid #000000;
            border-bottom: 1px solid #000000;
            text-align: center;
            border-collapse: collapse;
        }

        table th {
            padding: 5px 20px;
            margin: 0;
            border-left: 1px solid #000000;
            border-top: 1px solid #000000;
        }

        table td {
            padding: 5px 20px;
            margin: 0;
            border-left: 1px solid #000000;
            border-top: 1px solid #000000;
        }
        .loading-data {
            display: none;
        }
    </style>
</head>
<body>
<!-- https://cdnjs.com/ -->
<!-- https://unpkg.com/ -->
<!-- https://cdn.jsdelivr.net/ -->

<!-- https://mozilla.github.io/pdf.js/ -->
<!-- https://pdf-lib.js.org/ -->
<!-- https://www.npmjs.com/package/jspdf -->

<!-- https://sheetjs.com/ -->
<!-- https://github.com/exceljs/exceljs -->
<input id="pdfFile" type="file" multiple accept="application/pdf, image/*" />
<button id="downloadExcel">下载Excel</button>
<h1 class="loading-data">读取PDF数据中......</h1>
<h1>商标</h1>
<div>
    <table id="tbSb">
        <thead>
        <tr>
            <th>序号</th>
            <th>商标</th>
            <th>类别</th>
            <th>官方收文编号/申请号/注册号</th>
            <th>申请日</th>
            <th>申请人</th>
            <th>锺维案号</th>
            <th>注册日期</th>
            <th>有效期至</th>
        </tr>
        </thead>
        <tbody id="tbDataSb"></tbody>
    </table>
</div>
<h1>软著</h1>
<div>
    <table id="tbRz">
        <thead>
        <tr>
            <th>序号</th>
            <th>软件全称</th>
            <th>流水号</th>
            <th>登记号</th>
            <th>著作权人</th>
            <th>登记日期</th>
        </tr>
        </thead>
        <tbody id="tbDataRz"></tbody>
    </table>
</div>
</body>
<script src="https://unpkg.com/pdfjs-dist@3.9.179/build/pdf.min.js"></script>
<script src="https://unpkg.com/pdfjs-dist@3.9.179/build/pdf.sandbox.min.js"></script>
<!--<script src="https://unpkg.com/pdfjs-dist@3.9.179/build/pdf.worker.min.js"></script>-->
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    // excel 下载 start
    let dataAll = {
        "商标": [],
        "类别": [],
        "官方收文编号/申请号/注册号": [],
        "申请日": [],
        "申请人": [],
        "锺维案号": [],
        "注册日期": [],
        "有效期至": [],
        "软件全称": [],
        "流水号": [],
        "登记号": [],
        "著作权人": [],
        "登记日期": []
    };
    const titleSb = ["序号", "商标", "类别", "官方收文编号/申请号/注册号", "申请日", "申请人", "锺维案号", "注册日期", "有效期至"];
    let dataSb = [];
    const titleRz = ["序号", "软件全称", "流水号", "登记号", "著作权人", "登记日期"];
    let dataRz = [];
    const dataTypeEnum = { gjzscqj: "国家知识产权局", sbzcsqs: "商 标 注 册 申 请 书", rjdjsls: "软件登记受理通知书" };
    // excel 下载 end
    // 是否渲染数据
    let isShowHtmlFlag = [false, false, false];

    ((dom) => {
        // pdf 上传及解析 start
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@3.9.179/build/pdf.worker.min.js";
        pdfjsLib.cMapUrl = "https://unpkg.com/pdfjs-dist@3.9.179/cmaps/";

        document.getElementById("pdfFile").addEventListener("change", async (e) => {
            const files = e.target.files;
            if (!files) return false;
            let flag = 1;
            for (let file of files) {
                ++flag;
                if (file.type.includes("image")) {
                    const reqUrl = "http://47.92.233.92:9999/ocr/image/scan";

                    let formData = new FormData();
                    formData.append("file", file);

                    // const http = new XMLHttpRequest();
                    // http.open("POST", reqUrl);
                    // http.send(formData);

                    const resp = await fetch(reqUrl, {method: "POST", body: formData});
                    const res = await resp.json();
                    console.log(res);
                } else {
                    let fileReader = new FileReader();
                    fileReader.readAsArrayBuffer(file);
                    fileReader.onload = async (event) => {
                        const pdfData = new Uint8Array(event.target.result);
                        const task = pdfjsLib.getDocument({ data: pdfData });
                        const pdf = await task.promise;

                        // 获取唯一标识
                        const page = await pdf.getPage(1);
                        const textContent = await page.getTextContent();
                        if (!textContent.items.length) return false;
                        const pdfDataArray = textContent.items.map((item) => item.str);
                        for (let t of pdfDataArray) {
                            let isBreak = false;
                            switch (t) {
                                case dataTypeEnum.gjzscqj: isBreak = true; await getDataGjzscqj(pdf); break;
                                case dataTypeEnum.sbzcsqs: isBreak = true; await getDataSbzcsqs(pdf); break;
                                case dataTypeEnum.rjdjsls: isBreak = true; await getDataRjdjsls(pdf); break;
                                default: isBreak = false; ;
                            }
                            if (isBreak) return false;
                        }

                        // for (let i = 1; i <= pdf.numPages; i++) {
                        //     const page = await pdf.getPage(i);
                        //     const textContent = await page.getTextContent();
                        //     const pdfDataArray = textContent.items.map((item) => item.str);
                        //     console.log("======", pdfDataArray);
                        // }
                    };
                }
                // 循环完毕，调用
                if (flag === files.length) {
                    dataToHtml();
                }
            }
        });
        // pdf 上传及解析 end

        // excel 下载 start
        document.getElementById("downloadExcel").addEventListener("click", () => {
            let wb = XLSX.utils.book_new();
            let wsSb = XLSX.utils.json_to_sheet(dataSb, { header: titleSb });
            XLSX.utils.book_append_sheet(wb, wsSb, "商标");
            let wsRz = XLSX.utils.json_to_sheet(dataRz, { header: titleRz });
            XLSX.utils.book_append_sheet(wb, wsRz, "软著");
            XLSX.writeFile(wb, "商标_软著_宋宋.xlsx");
        });
        // excel 下载 end
    })(window);

    // 处理数据 - 国家知识产权局
    async function getDataGjzscqj(pdf) {
        const page = await pdf.getPage(1);
        const textContent = await page.getTextContent();
        const pdfDataArray = textContent.items.map((item) => item.str);
        dataAll["申请人"].push(pdfDataArray[0]);
        dataAll["官方收文编号/申请号/注册号"].push(pdfDataArray[18]);
        dataAll["申请日"].push(pdfDataArray[20]);

        isShowHtmlFlag[0] = true;
    }
    // 处理数据 - 商 标 注 册 申 请 书
    async function getDataSbzcsqs(pdf) {
        const page = await pdf.getPage(1);
        const textContent = await page.getTextContent();
        const pdfDataArray = textContent.items.map((item) => item.str);

        // dataAll["申请人"].push(pdfDataArray[36].split("：")[1]);
        dataAll["锺维案号"].push(pdfDataArray[27]);

        const page2 = await pdf.getPage(2);
        const textContent2 = await page2.getTextContent();
        const pdfDataArray2 = textContent2.items.map((item) => item.str);
        dataAll["商标"].push(pdfDataArray2[27].split("：")[1]);
        dataAll["类别"].push(pdfDataArray2[13].split("：")[1]);

        isShowHtmlFlag[1] = true;
    }
    // 处理数据 - 软件登记受理通知书
    async function getDataRjdjsls(pdf) {
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pdfDataArray = textContent.items.map((item) => item.str);
            dataAll["软件全称"].push(pdfDataArray[22]);
            dataAll["流水号"].push(pdfDataArray[16]);
            dataAll["著作权人"].push(pdfDataArray[36]);
            dataAll["登记日期"].push(pdfDataArray[85]);
            dataAll["登记号"].push("");
        }
        isShowHtmlFlag[2] = true;
    }

    // 将数据渲染到页面上
    function dataToHtml() {
      document.getElementsByClassName("loading-data")[0].style.display = "block";
      const isShowFlag = isShowHtmlFlag[0] && isShowHtmlFlag[1] && isShowHtmlFlag[2];
        let timeObj = setTimeout(() => {
            if (isShowFlag) {
                document.getElementsByClassName("loading-data")[0].style.display = "none";
                timeObj = null;
                clearTimeout(timeObj);
                for (let i in dataAll["软件全称"]) {
                  dataSb.push({
                    "序号": Number(i)+1,
                    "商标": dataAll["商标"][0],
                    "类别": dataAll["类别"][0],
                    "官方收文编号/申请号/注册号": dataAll["官方收文编号/申请号/注册号"][0],
                    "申请日": dataAll["申请日"][0],
                    "申请人": dataAll["申请人"][0],
                    "锺维案号": dataAll["锺维案号"][0],
                    "注册日期": dataAll["注册日期"][0] || "",
                    "有效期至": dataAll["有效期至"][0] || ""
                  });
                  dataRz.push({
                    "序号": Number(i)+1,
                    "软件全称": dataAll["软件全称"][i],
                    "流水号": dataAll["流水号"][i],
                    "登记号": dataAll["登记号"][i],
                    "著作权人": dataAll["著作权人"][i],
                    "登记日期": dataAll["登记日期"][i]
                  });
                }
                let htmlSb = "";
                for (let iSb in dataSb) {
                    htmlSb += `<tr>
                        <td>${dataSb[iSb]["序号"]}</td>
                        <td>${dataSb[iSb]["商标"]}</td>
                        <td>${dataSb[iSb]["类别"]}</td>
                        <td>${dataSb[iSb]["官方收文编号/申请号/注册号"]}</td>
                        <td>${dataSb[iSb]["申请日"]}</td>
                        <td>${dataSb[iSb]["申请人"]}</td>
                        <td>${dataSb[iSb]["锺维案号"]}</td>
                        <td>${dataSb[iSb]["注册日期"]}</td>
                        <td>${dataSb[iSb]["有效期至"]}</td>
                       </tr>`;
                }
                document.getElementById("tbDataSb").innerHTML = htmlSb;
                let htmlRz = "";
                for (let iRz in dataRz) {
                    htmlRz += `<tr>
                        <td>${dataSb[iRz]["序号"]}</td>
                        <td>${dataRz[iRz]["软件全称"]}</td>
                        <td>${dataRz[iRz]["流水号"]}</td>
                        <td>${dataRz[iRz]["登记号"]}</td>
                        <td>${dataRz[iRz]["著作权人"]}</td>
                        <td>${dataRz[iRz]["登记日期"]}</td>
                       </tr>`;
                }
                document.getElementById("tbDataRz").innerHTML = htmlRz;
            } else {
                dataToHtml();
            }
        }, 5000);
    }
    function getFileUrl(file) {
        let url = null;
        if (window.createObjectURL !== undefined) {
            url = window.createObjectURL(file);
        } else if (window.URL !== undefined) {
            url = window.URL.createObjectURL(file);
        } else if (window.webkitURL !== undefined) {
            url = window.webkitURL.createObjectURL(file);
        }
        return url;
    }
</script>
</html>
